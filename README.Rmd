---
output:
  md_document:
    variant: gfm
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-figs/",
  cache.path = "README-cache/"
)
options(width = 120) # for printing Stan output
```

# glmmfields

[![Travis-CI Build Status](https://travis-ci.org/seananderson/glmmfields.svg?branch=master)](https://travis-ci.org/seananderson/glmmfields)
[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/seananderson/glmmfields?branch=master&svg=true)](https://ci.appveyor.com/project/seananderson/glmmfields)
<!-- [![codecov](https://codecov.io/github/seananderson/glmmfields/branch/master/graphs/badge.svg)](https://codecov.io/github/seananderson/glmmfields) -->

The glmmfields R package implements Bayesian spatiotemporal models that allow for extreme
spatial deviations through time. It uses a predictive process approach with
random fields implemented through a multivariate-t distribution instead of a
multivariate normal. The models are fit with [Stan](http://mc-stan.org/).

You can install the development version of the package with:

```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("seananderson/glmmfields")
```

glmmfields can also fit spatial GLMs with Stan. See the vignette:

```{r, eval=FALSE}
vignette("spatial-glms", package = "glmmfields")
```

## An example spatiotemporal model

```{r libraries, cache=FALSE}
library(glmmfields)
library(ggplot2)
```

Simulate data:

```{r simulate, cache=TRUE}
set.seed(42)
s <- sim_glmmfields(
  df = 2.8, n_draws = 12, n_knots = 12, gp_theta = 2.5,
  gp_sigma = 0.2, sd_obs = 0.1
)
head(s$dat)
```

```{r plot-sim, cache=TRUE, dependson="simulate"}
print(s$plot)
```

Fit the model:

```{r fit, cache=TRUE, warning=FALSE, message=FALSE, results='hide', dependson="simulate", cache.comments=FALSE}
options(mc.cores = parallel::detectCores()) # for parallel processing
m <- glmmfields(y ~ 0,
  data = s$dat, time = "time",
  lat = "lat", lon = "lon",
  nknots = 12, estimate_df = TRUE, iter = 800, seed = 1
)
```

```{r print, cache=FALSE, dependson="fit"}
print(m)
```

Plot:

```{r plot-predictions, dependson="fit"}
plot(m, type = "prediction") + scale_color_gradient2()
plot(m, type = "spatial-residual")
```

Predictions:

```{r get-predictions, dependson="fit"}
# link scale:
p <- predict(m)
head(p)

# posterior predictive intervals on new observations (include observation error):
p <- predictive_interval(m)
head(p)
```

Use the `tidy` method to extract parameter estimates as a data frame:

```{r tidy, dependson="fit"}
x <- tidy(m, conf.int = TRUE)
head(x)
```

Make predictions on a fine-scale spatial grid:

```{r grid-predictions, dependson="fit"}
pred_grid <- expand.grid(
  lat = seq(min(s$dat$lat), max(s$dat$lat), length.out = 25),
  lon = seq(min(s$dat$lon), max(s$dat$lon), length.out = 25),
  time = unique(s$dat$time)
)

pred_grid$prediction <- predict(m,
  newdata = pred_grid, type = "response", iter = 100, estimate_method = "median"
)$estimate

ggplot(pred_grid, aes(lon, lat, fill = prediction)) +
  facet_wrap(~time) +
  geom_raster() +
  scale_fill_gradient2()
```

# References

Anderson, S. A., Ward, E. J. In press. Black swans in space: modelling spatiotemporal processes with extremes. [Code](https://github.com/seananderson/spatial-extremes)

Latimer, A. M., S. Banerjee, H. Sang Jr, E. S. Mosher, and J. A. Silander Jr. 2009. Hierarchical models facilitate spatial analysis of large data sets: a case study on invasive plant species in the northeastern United States. Ecology Letters 12:144–154.

Shelton, A. O., J. T. Thorson, E. J. Ward, and B. E. Feist. 2014. Spatial semiparametric models improve estimates of species abundance and distribution. Canadian Journal of Fisheries and Aquatic Sciences 71:1655–1666.

